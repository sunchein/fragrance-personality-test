<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åäºŒé¦™æ°›äººæ ¼æ¸¬è©•ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal-backdrop { backdrop-filter: blur(3px); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans leading-relaxed">
    <!-- Netlify Form æ¨™è¨˜ -->
    <form name="test-results" netlify netlify-honeypot="bot-field" hidden>
      <input type="text" name="userName" /><input type="text" name="userPhone" />
      <input type="text" name="userNote" /><input type="text" name="resultType" />
      <input type="text" name="lineUserId" /><input type="text" name="lineDisplayName" />
      <input type="text" name="timestamp" />
    </form>
    
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">åäºŒé¦™æ°›äººæ ¼æ¸¬è©•ç³»çµ±</h1>
            <p class="text-gray-600 text-sm">æ¢ç´¢æ‚¨çš„å°ˆå±¬é¦™æ°›å»ºè­°èˆ‡éˆé­‚æ”¯æ´¾</p>
        </header>

        <!-- ç™»å…¥èˆ‡å—æ¸¬è€…è³‡è¨Š -->
        <section id="infoSection" class="bg-white p-6 rounded-2xl card-shadow mb-8 border border-gray-50">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-address-card mr-3 text-blue-600"></i>å—æ¸¬è€…ç™»å…¥
            </h2>
            
            <div id="lineStatus" class="mb-4 text-sm text-blue-700 bg-blue-50 border border-blue-100 rounded-xl p-4 text-center font-medium">
                æ­£åœ¨æª¢æŸ¥ LINE é€£ç·šç‹€æ…‹...
            </div>
            
            <div id="lineProfileCard" class="hidden mb-6 border border-gray-100 rounded-2xl p-4 bg-gray-50 flex items-center gap-4">
              <img id="lineAvatar" alt="LINE" class="w-14 h-14 rounded-full border-2 border-white shadow-sm" src="" />
              <div>
                <div class="text-xs text-gray-400 font-bold uppercase">Connected</div>
                <div id="lineDisplayNameText" class="text-lg font-black text-gray-800"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">æ‚¨çš„å§“å</label>
                    <input id="userName" type="text" class="w-full border-gray-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="è«‹è¼¸å…¥å§“å">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">è¯çµ¡é›»è©±</label>
                    <input id="userPhone" type="tel" class="w-full border-gray-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="é¸å¡«">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">å‚™è¨»è³‡è¨Š</label>
                    <input id="userNote" type="text" class="w-full border-gray-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="é¸å¡«">
                </div>
            </div>
            
            <div class="flex flex-col gap-3">
                <button id="startTestBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-100 transition-all flex items-center justify-center gap-2 text-lg">
                    <i class="fa fa-play"></i> é–‹å§‹äººæ ¼æ¸¬è©•
                </button>
                <button id="viewHistoryBtn" class="text-gray-400 hover:text-gray-600 py-2 text-xs font-bold tracking-widest uppercase transition-colors">
                    <i class="fa fa-lock mr-1"></i> ç®¡ç†å“¡æ­·å²æ•¸æ“šä¸­å¿ƒ
                </button>
            </div>
        </section>

        <!-- å•å·å€ -->
        <section id="questionSection" class="bg-white p-8 rounded-3xl card-shadow mb-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div class="h-2 flex-grow bg-gray-100 rounded-full mr-4 overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-600 transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="progressText" class="text-xs font-black text-blue-600 whitespace-nowrap bg-blue-50 px-3 py-1 rounded-full">1 / 12</span>
            </div>
            <div id="questionContainer" class="mb-10 min-h-[160px]"></div>
            <div class="flex gap-4">
                <button id="prevQuestionBtn" class="flex-1 bg-gray-100 text-gray-400 font-bold py-4 rounded-2xl disabled:opacity-30">ä¸Šä¸€é¡Œ</button>
                <button id="nextQuestionBtn" class="flex-[2] bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-50">ä¸‹ä¸€é¡Œ</button>
            </div>
        </section>

        <!-- çµæœå ±å‘Šå€ -->
        <section id="resultSection" class="hidden">
            <div id="resultContent" class="bg-white rounded-3xl overflow-hidden shadow-2xl mb-8 border border-gray-100">
                <!-- ç”± JS æ³¨å…¥å…§å®¹ -->
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="exportPdfBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2">
                    <i class="fa fa-file-pdf-o"></i> ä¸‹è¼‰ PDF å ±å‘Š
                </button>
                <button id="restartBtn" class="bg-slate-800 hover:bg-black text-white font-black py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2">
                    <i class="fa fa-refresh"></i> é‡æ–°æ¸¬è©•
                </button>
            </div>
        </section>

        <!-- ç®¡ç†å“¡æ­·å²ç´€éŒ„ Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black/70 modal-backdrop hidden flex items-center justify-center z-[100] p-4">
            <div class="bg-white rounded-3xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                    <div>
                        <h3 class="text-xl font-black text-gray-800">å—æ¸¬è€…å¤§æ•¸æ“šåˆ†æä¸­å¿ƒ</h3>
                        <p class="text-xs text-gray-400 mt-1">å³æ™‚æŠ“å– Netlify é›²ç«¯è¡¨å–®è³‡æ–™</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="syncNetlifyBtn" class="bg-green-600 text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                            <i class="fa fa-cloud-download"></i> åŒæ­¥é›²ç«¯è³‡æ–™
                        </button>
                        <button id="closeHistoryBtn" class="text-gray-400 hover:text-gray-600 p-2"><i class="fa fa-times text-2xl"></i></button>
                    </div>
                </div>
                <div id="historyList" class="overflow-y-auto flex-grow p-6 bg-gray-50/50 space-y-4">
                    <div class="text-center py-20 text-gray-400">
                        <p>é»æ“Šå³ä¸Šæ–¹ã€ŒåŒæ­¥é›²ç«¯è³‡æ–™ã€ä»¥ç²å–æ‰€æœ‰ç·šä¸Šè¨˜éŒ„</p>
                    </div>
                </div>
                <div class="p-4 border-t bg-white flex justify-between items-center">
                    <p class="text-[10px] text-gray-300 font-medium">æ³¨æ„ï¼šé›²ç«¯åŒæ­¥éœ€è¼¸å…¥ Netlify API Token</p>
                    <button id="clearHistoryBtn" class="text-red-400 text-[10px] font-bold uppercase tracking-widest hover:text-red-600 transition-colors">æ¸…ç©ºæœ¬åœ°å¿«å–</button>
                </div>
            </div>
        </div>
    </div>

    <script>
// ===== é…ç½®è³‡æ–™ =====
const LIFF_ID = "2008610266-8jDqPJAe";
const STORAGE_KEY = 'fragrancePersonalityResults';
const NETLIFY_SITE_ID = "fragrance-personality-test"; // æ‚¨çš„ Netlify Site ID

let lineProfile = null;
let isLiffInit = false;

// åˆå§‹åŒ– LINE
async function initLine() {
    if (isLiffInit) return true;
    try {
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        isLiffInit = true;
        if (!liff.isLoggedIn()) {
            liff.login();
            return false;
        }
        lineProfile = await liff.getProfile();
        document.getElementById('lineStatus').classList.add('hidden');
        document.getElementById('lineProfileCard').classList.remove('hidden');
        document.getElementById('lineAvatar').src = lineProfile.pictureUrl || "";
        document.getElementById('lineDisplayNameText').textContent = lineProfile.displayName || "";
        document.getElementById('userName').value = lineProfile.displayName || "";
        return true;
    } catch (err) {
        document.getElementById('lineStatus').textContent = "LINE ç™»å…¥ç’°å¢ƒç•°å¸¸ï¼Œè«‹é‡æ–°æ•´ç†ã€‚";
        return false;
    }
}

// åäºŒäººæ ¼è³‡æ–™ (æ“·å–é‡é»)
const personalityData = {
    leader: { code: "01", name: "é ˜å°è€… (Leader)", traits: "æœæ–·ã€æ¬Šå¨ã€ç›®æ¨™å°å‘", scentType: "æœ¨è³ªè¾›é¦™èª¿", essentialOilName: "èµ¤ç„°åˆå¿ƒ", essentialOilFormula: "é»‘èƒ¡æ¤’+è‚‰æ¡‚çš®+è–‘", perfumeName: "ç‹è€…è„ˆå‹•", perfumeFormula: "å‰:ä½›æ‰‹æŸ‘ | ä¸­:è–‘ | å¾Œ:é›ªæ¾", colorHex: "#FF4500", tribe: "çŒ¶å¤§", blessingClue: "å›ç‹è¡€è„ˆï¼Œè¬æ°‘æ­¸é †ã€‚", scripture: "å‰µä¸–è¨˜ 49:8-10" },
    collaborator: { code: "02", name: "åˆä½œè€… (Collaborator)", traits: "è¦ªå’Œã€åŒ…å®¹ã€æº«æš–", scentType: "ç™½èŠ±éºé¦™èª¿", essentialOilName: "æ™¨æ›¦æ“æŠ±", essentialOilFormula: "ç”œæ©™+å¤©ç«ºè‘µ+è–°è¡£è‰", perfumeName: "å…‰ä¹‹å’Œè«§", perfumeFormula: "å‰:æ©˜å­èŠ± | ä¸­:ç«ç‘° | å¾Œ:æª€é¦™", colorHex: "#FFA500", tribe: "è¥¿ç·¬", blessingClue: "åˆ†æ•£è¯åˆï¼Œèå…¥å„æ”¯æ´¾ã€‚", scripture: "å‰µä¸–è¨˜ 49:5-7" },
    creator: { code: "03", name: "å‰µæ„è€… (Creator)", traits: "éˆæ„Ÿã€è‡ªç”±ã€è—è¡“æ€§", scentType: "æŸ‘æ©˜èŠ±é¦™èª¿", essentialOilName: "é‡‘å…‰æ¨‚ç« ", essentialOilFormula: "æª¸æª¬+ä½›æ‰‹æŸ‘+ç¾…å‹’", perfumeName: "é»ƒé‡‘éˆæ„Ÿ", perfumeFormula: "å‰:æª¸æª¬ | ä¸­:èŒ‰è‰ | å¾Œ:é›ªæ¾", colorHex: "#FFD700", tribe: "äºè¨­", blessingClue: "è±ç¾å°Šæ¦®ï¼Œå‰µä½œä½³é¤šã€‚", scripture: "å‰µä¸–è¨˜ 49:20" },
    implementer: { code: "04", name: "å¯¦è¸è€… (Implementer)", traits: "å‹™å¯¦ã€ç©©å®šã€è€åŠ›", scentType: "æœ¨è³ªæŸ‘è‹”èª¿", essentialOilName: "èƒå²©ç£çŸ³", essentialOilFormula: "æªœæœ¨+é»‘é›²æ‰+çµ²æŸ", perfumeName: "å¤§åœ°ä¹‹æ¯", perfumeFormula: "å‰:è¿·è¿­é¦™ | ä¸­:çµ²æŸ | å¾Œ:ä¹³é¦™", colorHex: "#228B22", tribe: "ä»¥è–©è¿¦", blessingClue: "è² é‡å‰è¡Œï¼Œå»ºé€ å®¶åœ’ã€‚", scripture: "å‰µä¸–è¨˜ 49:14-15" },
    adventurer: { code: "05", name: "å†’éšªè€… (Adventurer)", traits: "å¥½å¥‡ã€å‹‡æ•¢ã€è‡ªç”±", scentType: "æ¸…æ–°æœ¨è³ªèª¿", essentialOilName: "èŠè’¼ä¹‹é¢¨", essentialOilFormula: "è–„è·+æœæ¾+å†·æ‰", perfumeName: "æ£®æ—å‹‡æ°£", perfumeFormula: "å‰:è‘¡è„æŸš | ä¸­:è–„è· | å¾Œ:éºé¦™", colorHex: "#00BFFF", tribe: "è¥¿å¸ƒå€«", blessingClue: "èˆªå‘å››æµ·ï¼Œæ¢ç´¢å•†æ©Ÿã€‚", scripture: "å‰µä¸–è¨˜ 49:13" },
    guardian: { code: "06", name: "å®ˆè­·è€… (Guardian)", traits: "å¿ èª ã€ä¿è­·ã€å®‰å®š", scentType: "è‰æœ¬èŠ±é¦™æœ¨è³ªèª¿", essentialOilName: "é›è—æ–ç±ƒæ›²", essentialOilFormula: "ä¹³é¦™+çµ²æŸ+è–°è¡£è‰", perfumeName: "å¿ èª ä¹‹ç›¾", perfumeFormula: "å‰:è–°è¡£è‰ | ä¸­:ä¹³é¦™ | å¾Œ:å²©è˜­è‰", colorHex: "#4B0082", tribe: "å‘‚ä¾¿", blessingClue: "èº«ç‚ºé•·å­ï¼Œå®ˆè­·æ ¹åŸºã€‚", scripture: "å‰µä¸–è¨˜ 49:3-4" },
    explorer: { code: "07", name: "æ¢ç´¢è€… (Explorer)", traits: "ç¥ç§˜ã€è¿½å°‹ã€éˆæ€§", scentType: "æ¨¹è„‚æœ¨è³ªèª¿", essentialOilName: "ç´«æ™¶è–å£‡", essentialOilFormula: "ä¹³é¦™+æœæ¾+é¼ å°¾è‰", perfumeName: "éœè¬ä¹‹å¿ƒ", perfumeFormula: "å‰:é»‘èƒ¡æ¤’ | ä¸­:é¼ å°¾è‰ | å¾Œ:ç¥ç€", colorHex: "#9370DB", tribe: "ä½†", blessingClue: "ç¨é—¢è¹Šå¾‘ï¼Œæ™ºæ…§å¯©åˆ¤ã€‚", scripture: "å‰µä¸–è¨˜ 49:16-17" },
    achiever: { code: "08", name: "æˆå°±è€… (Achiever)", traits: "ç›®æ¨™ã€é©…å‹•åŠ›ã€æ¦®è€€", scentType: "æœ¨è³ªè¾›é¦™èª¿", essentialOilName: "éé‡‘æ¬Šæ–", essentialOilFormula: "è–‘+é»‘èƒ¡æ¤’+è‚‰æ¡‚è‘‰", perfumeName: "æ¦®è€€æ¡‚å† ", perfumeFormula: "å‰:ä½›æ‰‹æŸ‘ | ä¸­:ç”Ÿè–‘ | å¾Œ:ä¹³é¦™", colorHex: "#DAA520", tribe: "è¿¦å¾—", blessingClue: "æˆ°å£«ç²¾ç¥ï¼Œçµ‚å¿…å¾—å‹ã€‚", scripture: "å‰µä¸–è¨˜ 49:19" },
    idealist: { code: "09", name: "ç†æƒ³è€… (Idealist)", traits: "æµªæ¼«ã€ç´”æ½”ã€ç†æƒ³æ€§", scentType: "èŠ±é¦™æŸ‘è‹”èª¿", essentialOilName: "æœˆå…‰è–æ¯", essentialOilFormula: "å¤©ç«ºè‘µ+è–°è¡£è‰+ä½›æ‰‹æŸ‘", perfumeName: "è±ç››èŠ±åœ’", perfumeFormula: "å‰:æ©™èŠ± | ä¸­:ç«ç‘° | å¾Œ:ç™½éºé¦™", colorHex: "#F0E68C", tribe: "ä¾¿é›…æ†«", blessingClue: "é©å‹‡å–„æˆ°ï¼Œå¯¦ç¾ç†æƒ³ã€‚", scripture: "å‰µä¸–è¨˜ 49:27" },
    inspirator: { code: "10", name: "éˆæ„Ÿè€… (Inspirator)", traits: "éˆæ€§ã€å•Ÿç™¼ã€ç„¡é™", scentType: "ç†é¦™ç¥ç€èª¿", essentialOilName: "éŠ€æ²³æ˜Ÿå¡µ", essentialOilFormula: "æª¸æª¬+é¼ å°¾è‰+ç™½åƒå±¤", perfumeName: "å•Ÿè¿ªä¹‹å…‰", perfumeFormula: "å‰:è–„è· | ä¸­:è¿·è¿­é¦™ | å¾Œ:ç¥ç€", colorHex: "#E6E6FA", tribe: "æ‹¿å¼—ä»–åˆ©", blessingClue: "è‡ªç”±é‡‹æ”¾ï¼Œè¨€èªå˜‰ç¾ã€‚", scripture: "å‰µä¸–è¨˜ 49:21" },
    architect: { code: "11", name: "å»ºç¯‰å¤§å¸« (Architect)", traits: "ç©©å›ºã€çµæ§‹ã€å‹™å¯¦", scentType: "ç¶ æ„æŸ‘è‹”èª¿", essentialOilName: "å¤§åœ°åŸºçŸ³", essentialOilFormula: "é»‘é›²æ‰+è‚–æ¥ +èŠ³æ¨Ÿ", perfumeName: "è’¼ç¿ ä¹‹æŸ±", perfumeFormula: "å‰:é»‘èƒ¡æ¤’ | ä¸­:é›ªæ¾ | å¾Œ:å²©è˜­è‰", colorHex: "#8B4513", tribe: "ç´„ç‘Ÿ", blessingClue: "å•Ÿç¤ºè±ç››ï¼Œå»ºç«‹æœªä¾†ã€‚", scripture: "å‰µä¸–è¨˜ 49:22-26" },
    soulMentor: { code: "12", name: "éˆé­‚å°å¸« (Soul Mentor)", traits: "æ™ºæ…§ã€è–æ½”ã€å•Ÿè¿ª", scentType: "èŠ±é¦™æ±æ–¹èª¿", essentialOilName: "è–æ„›å…‰å†•", essentialOilFormula: "ä¹³é¦™+å®‰æ¯é¦™+ç¾…æ–‡èè‘‰", perfumeName: "è–æ½”åŒåœ¨", perfumeFormula: "å‰:ä½›æ‰‹æŸ‘ | ä¸­:æ²’è—¥ | å¾Œ:ç¥ç€", colorHex: "#FFFACD", tribe: "åˆ©æœª", blessingClue: "åˆ†åˆ¥ç‚ºè–ï¼Œæ•™å°å¾‹æ³•ã€‚", scripture: "ç”³å‘½è¨˜ 33:8-11" }
};

const questions = [
    { id: 1, text: "æˆ‘å–œæ­¡è¨­å®šæ–¹å‘ä¸¦å¸¶é ˜ä»–äººå®Œæˆç›®æ¨™ã€‚", dim: "leader" },
    { id: 2, text: "æˆ‘é‡è¦–åœ˜éšŠåˆä½œï¼Œé¡˜æ„è†è½ä¸¦æ”¯æŒä»–äººã€‚", dim: "collaborator" },
    { id: 3, text: "æˆ‘å¯Œæœ‰å‰µæ„ï¼Œå–œæ­¡å˜—è©¦æ–°é»å­æˆ–è—è¡“è¡¨é”ã€‚", dim: "creator" },
    { id: 4, text: "æˆ‘å‹™å¯¦ç©©å¥ï¼Œå–œæ­¡æŒ‰è¨ˆåŠƒæŒçºŒæ¨é€²ã€‚", dim: "implementer" },
    { id: 5, text: "æˆ‘å–œæ­¡å†’éšªå’Œæ¢ç´¢æœªçŸ¥ï¼Œå°æ–°é«”é©—å……æ»¿å¥½å¥‡ã€‚", dim: "adventurer" },
    { id: 6, text: "æˆ‘å…·å‚™ä¿è­·ä»–äººèˆ‡æä¾›æ”¯æŒçš„å¤©æ€§ã€‚", dim: "guardian" },
    { id: 7, text: "æˆ‘å°å®‡å®™èˆ‡è‡ªæˆ‘éˆæ€§å±¤é¢æ„Ÿèˆˆè¶£ã€‚", dim: "explorer" },
    { id: 8, text: "æˆ‘æœ‰å¼·çƒˆçš„ç›®æ¨™æ„Ÿå’Œé©…å‹•åŠ›ã€‚", dim: "achiever" },
    { id: 9, text: "æˆ‘æ³¨é‡ç†æƒ³èˆ‡æµªæ¼«ï¼Œå¸¸å¸¸å¾å¤¢æƒ³ç²å¾—åŠ›é‡ã€‚", dim: "idealist" },
    { id: 10, text: "æˆ‘å°éˆæ€§èˆ‡å•Ÿç™¼æ€§çš„ç¶“é©—æ„Ÿèˆˆè¶£ã€‚", dim: "inspirator" },
    { id: 11, text: "æˆ‘å–„æ–¼å»ºç«‹çµæ§‹èˆ‡ç§©åºï¼Œé‡è¦–å¯¦ç”¨ã€‚", dim: "architect" },
    { id: 12, text: "æˆ‘æ¸´æœ›å•Ÿè¿ªä»–äººéˆé­‚ï¼Œè¿½æ±‚æ™ºæ…§çš„ç”Ÿæ´»ã€‚", dim: "soulMentor" }
];

let currentIdx = 0;
const responses = {};

// æµç¨‹æ§åˆ¶
document.getElementById('startTestBtn').onclick = async () => {
    const ok = await initLine();
    if (!ok) return;
    if (!document.getElementById('userName').value.trim()) return alert("è«‹è¼¸å…¥å—æ¸¬è€…å§“åï¼");
    currentIdx = 0;
    document.getElementById('infoSection').classList.add('hidden');
    document.getElementById('questionSection').classList.remove('hidden');
    renderQuestion();
};

function renderQuestion() {
    const q = questions[currentIdx];
    const progress = Math.round(((currentIdx + 1) / questions.length) * 100);
    document.getElementById('progressBar').style.width = progress + "%";
    document.getElementById('progressText').textContent = `${currentIdx + 1} / ${questions.length}`;
    
    document.getElementById('questionContainer').innerHTML = `
        <h3 class="text-2xl font-black text-slate-800 mb-8 leading-tight animate-in fade-in duration-500">${q.text}</h3>
        <div class="space-y-4">
            ${[1,2,3,4,5].map(v => `
                <button onclick="pick('${q.dim}', ${v})" class="w-full text-left p-5 border-2 rounded-2xl font-bold transition-all duration-200 ${responses[q.dim] === v ? 'border-blue-600 bg-blue-50 text-blue-700 shadow-lg' : 'border-gray-100 hover:border-blue-200 hover:bg-gray-50'}">
                    ${v===1?'ğŸ’” éå¸¸ä¸åŒæ„':v===2?'ä¸åŒæ„':v===3?'ä¸­ç«‹':v===4?'åŒæ„':'âœ¨ éå¸¸åŒæ„'}
                </button>`).join('')}
        </div>`;
    document.getElementById('prevQuestionBtn').disabled = currentIdx === 0;
}

window.pick = (dim, val) => {
    responses[dim] = val;
    renderQuestion();
};

document.getElementById('nextQuestionBtn').onclick = () => {
    if (!responses[questions[currentIdx].dim]) return alert("è«‹é¸æ“‡ä¸€å€‹ç¬¦åˆæ‚¨çš„ç¨‹åº¦ï¼");
    if (currentIdx < questions.length - 1) {
        currentIdx++; renderQuestion();
    } else { showResult(); }
};

document.getElementById('prevQuestionBtn').onclick = () => { currentIdx--; renderQuestion(); };

function showResult() {
    document.getElementById('questionSection').classList.add('hidden');
    document.getElementById('resultSection').classList.remove('hidden');
    
    const scores = Object.values(responses);
    const max = Math.max(...scores);
    const ties = Object.keys(responses).filter(d => responses[d] === max);
    const win = ties[Math.floor(Math.random() * ties.length)];
    const data = personalityData[win];
    
    const resObj = {
        userName: document.getElementById('userName').value.trim(),
        userPhone: document.getElementById('userPhone').value.trim(),
        userNote: document.getElementById('userNote').value.trim(),
        timestamp: new Date().toISOString(),
        type: data.name,
        details: data,
        line: lineProfile
    };
    
    saveResult(resObj);
    renderResult(resObj);
}

function renderResult(obj) {
    const d = obj.details;
    document.getElementById('resultContent').innerHTML = `
        <div class="p-10 text-white relative overflow-hidden" style="background-color: ${d.colorHex}">
            <div class="relative z-10">
                <div class="text-[10px] font-black opacity-80 uppercase tracking-[0.3em] mb-2">Soul Archetype Profile</div>
                <h2 class="text-5xl font-black">${d.name}</h2>
                <p class="mt-4 font-bold opacity-90">å—æ¸¬å°è±¡ï¼š${obj.userName}</p>
            </div>
            <div class="absolute -right-10 -bottom-10 opacity-10 text-[180px] font-black italic">#${d.code}</div>
        </div>
        <div class="p-8 space-y-8 bg-white">
            <div class="border-l-8 border-blue-600 pl-6">
                <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Core Personality ç‰¹è³ªæå¯«</span>
                <p class="text-xl font-bold text-slate-800 leading-relaxed mt-2">${d.traits}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-6 bg-blue-50/50 rounded-3xl border border-blue-100">
                    <span class="text-[10px] font-black text-blue-600 uppercase mb-2 block">Essential Oil ç²¾æ²¹é…æ–¹</span>
                    <p class="font-black text-gray-800 text-xl">${d.essentialOilName}</p>
                    <p class="text-xs text-blue-400 font-medium mt-1">${d.essentialOilFormula}</p>
                </div>
                <div class="p-6 bg-purple-50/50 rounded-3xl border border-purple-100">
                    <span class="text-[10px] font-black text-purple-600 uppercase mb-2 block">Perfume é¦™æ°´èª¿é…</span>
                    <p class="font-black text-gray-800 text-xl">${d.perfumeName}</p>
                    <p class="text-xs text-purple-400 font-medium mt-1">${d.perfumeFormula}</p>
                </div>
            </div>
            <div class="p-8 bg-amber-50 rounded-3xl border border-amber-100">
                <div class="text-xs font-black text-amber-600 mb-2 uppercase">æ”¯æ´¾ç¥ç¦å‚³æ‰¿ï¼š${d.tribe}</div>
                <p class="text-amber-900 font-black italic text-lg leading-relaxed mb-4">"${d.blessingClue}"</p>
                <p class="text-[10px] text-amber-400 font-bold text-right">â€” ${d.scripture}</p>
            </div>
        </div>`;
}

// ä¿å­˜è³‡æ–™
function saveResult(obj) {
    let local = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    local.push(obj);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(local));

    const body = new URLSearchParams({
        'form-name': 'test-results',
        ...obj,
        'lineUserId': obj.line?.userId || '',
        'lineDisplayName': obj.line?.displayName || '',
        'resultType': obj.type
    });
    fetch('/', { method: 'POST', body });
}

// æ ¸å¿ƒåŠŸèƒ½ï¼šæŠ“å– Netlify é›²ç«¯è³‡æ–™ (éœ€ PAT)
async function fetchCloudHistory() {
    const token = prompt("è«‹è¼¸å…¥æ‚¨çš„ Netlify Personal Access Token (PAT)ï¼š\n(é€™æ˜¯åœ¨ Netlify User Settings -> Applications ä¸­ç”Ÿæˆçš„)");
    if (!token) return;

    const listContainer = document.getElementById('historyList');
    listContainer.innerHTML = '<div class="text-center py-20"><div class="loader mr-2"></div> æ­£åœ¨å¾ Netlify é›²ç«¯æŠ“å–æ•¸æ“š...</div>';

    try {
        // å…ˆç²å– Site ID
        const sitesResp = await fetch('https://api.netlify.com/api/v1/sites', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const sites = await sitesResp.json();
        const site = sites.find(s => s.name === NETLIFY_SITE_ID || s.custom_domain?.includes(NETLIFY_SITE_ID));
        
        if (!site) throw new Error("æ‰¾ä¸åˆ°æŒ‡å®šçš„ Netlify ç«™é»ï¼Œè«‹ç¢ºèª NETLIFY_SITE_ID è¨­å®šã€‚");

        // æŠ“å– Submissions
        const subResp = await fetch(`https://api.netlify.com/api/v1/sites/${site.id}/submissions`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const submissions = await subResp.json();

        // æ¸²æŸ“åˆ—è¡¨
        listContainer.innerHTML = submissions.map(s => {
            const d = s.data;
            return `
                <div class="bg-white p-6 rounded-2xl border-2 border-gray-100 shadow-sm flex flex-col md:flex-row justify-between gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-black">å—æ¸¬è€…</span>
                            <h4 class="font-black text-gray-800 text-lg">${d.userName || 'åŒ¿å'}</h4>
                        </div>
                        <div class="space-y-1 text-[11px] text-gray-400">
                            <p><i class="fa fa-phone mr-1"></i>é›»è©±ï¼š${d.userPhone || 'ç„¡'}</p>
                            <p><i class="fa fa-user-circle mr-1"></i>LINE åç¨±ï¼š${d.lineDisplayName || 'æœªçŸ¥'}</p>
                            <p class="font-mono break-all opacity-50">UID: ${d.lineUserId || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="md:text-right flex flex-col justify-between">
                        <div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">äººæ ¼åˆ†æçµæœ</span>
                            <p class="text-blue-600 font-black text-xl">${d.resultType || 'ç„¡ç´€éŒ„'}</p>
                        </div>
                        <p class="text-[10px] text-gray-300 italic mt-2">${new Date(s.created_at).toLocaleString()}</p>
                    </div>
                </div>`;
        }).join('') || '<p class="text-center text-gray-400">é›²ç«¯è¡¨å–®å°šç„¡æäº¤è³‡æ–™</p>';

    } catch (err) {
        console.error(err);
        alert("æŠ“å–å¤±æ•—ï¼šè«‹æª¢æŸ¥ Token æ¬Šé™æˆ–ç¶²è·¯ç‹€æ…‹ã€‚");
        listContainer.innerHTML = '<p class="text-center py-20 text-red-400">æŠ“å–éŒ¯èª¤ï¼Œè«‹é‡æ–°åŒæ­¥ã€‚</p>';
    }
}

// ä¿®æ­£ PDF ç”Ÿæˆ
document.getElementById('exportPdfBtn').onclick = async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> è£½ä½œå ±å‘Šä¸­...';
    try {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById('resultContent');
        const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false });
        const pdf = new jsPDF('p', 'pt', 'a4');
        const w = pdf.internal.pageSize.getWidth();
        const h = (canvas.height * w) / canvas.width;
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, h);
        pdf.save(`äººæ ¼æ¸¬è©•_${document.getElementById('userName').value}.pdf`);
    } catch (e) {
        alert("PDF å¤±æ•—ï¼Œè«‹ç›´æ¥æˆªåœ–ä¿å­˜çµæœã€‚");
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa fa-file-pdf-o"></i> ä¸‹è¼‰ PDF å ±å‘Š';
    }
};

// é‡æ–°æ¸¬è©•èˆ‡å°è¦½
document.getElementById('restartBtn').onclick = () => window.location.reload();

document.getElementById('viewHistoryBtn').onclick = () => {
    if (prompt("è«‹è¼¸å…¥å¾Œå°ç®¡ç†å¯†ç¢¼ï¼š") === "a19690712") {
        document.getElementById('historyModal').classList.remove('hidden');
    } else { alert("æ¬Šé™ä¸è¶³ï¼"); }
};

document.getElementById('closeHistoryBtn').onclick = () => document.getElementById('historyModal').classList.add('hidden');
document.getElementById('syncNetlifyBtn').onclick = fetchCloudHistory;
document.getElementById('clearHistoryBtn').onclick = () => { if(confirm('ç¢ºå®šæ¸…ç©ºæœ¬åœ°ç´€éŒ„ï¼Ÿ')){ localStorage.removeItem(STORAGE_KEY); location.reload(); }};

window.onload = initLine;
    </script>
</body>
</html>
