<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>十二香氛人格測評系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-backdrop {
            backdrop-filter: blur(3px);
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans leading-relaxed">
    <!-- Netlify Form (用於資料收集) -->
    <form name="test-results" netlify netlify-honeypot="bot-field" hidden>
      <input type="text" name="userName" />
      <input type="text" name="userPhone" />
      <input type="text" name="userNote" />
      <input type="text" name="resultType" />
      <input type="text" name="lineUserId" />
      <input type="text" name="lineDisplayName" />
      <input type="text" name="linePictureUrl" />
      <input type="text" name="resultCode" />
      <input type="text" name="resultKey" />
      <input type="text" name="timestamp" />
    </form>
    
    <div class="container mx-auto px-4 py-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">十二香氛人格測評系統</h1>
            <p class="text-gray-600 text-sm">根據十二型香氛人格理論與12支派 為您定製專屬香氛建議。</p>
        </header>

        <!-- 資訊與登入區塊 -->
        <section id="infoSection" class="bg-white p-6 rounded-xl card-shadow mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-address-card mr-3 text-blue-600"></i>受測者資訊
            </h2>
            <div id="lineStatus" class="mb-4 text-sm text-gray-700 bg-blue-50 border border-blue-100 rounded-lg p-3">
                正在連接 LINE...
            </div>
            <div id="lineProfileCard" class="hidden mb-4 border border-gray-100 rounded-xl p-4 bg-white">
              <div class="flex items-center gap-3">
                <img id="lineAvatar" alt="LINE avatar" class="w-12 h-12 rounded-full object-cover border border-gray-200 shadow-sm" src="" />
                <div>
                  <div class="text-xs text-gray-400 font-medium">已連結 LINE 帳號</div>
                  <div id="lineDisplayNameText" class="text-base font-semibold text-gray-800"></div>
                </div>
              </div>
            </div>

            <div id="contactFields" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">姓名 (由 LINE 自動帶入)</label>
                    <input id="userName" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="載入姓名中...">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">聯絡電話 (選填)</label>
                    <input id="userPhone" type="tel" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="以便提供後續建議">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">備註 (選填)</label>
                    <input id="userNote" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="可填寫額外需求">
                </div>
            </div>
            
            <div class="flex flex-col gap-3">
                <button id="startTestBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-full transition-all duration-300 shadow-lg flex items-center justify-center gap-2">
                    <i class="fa fa-play"></i> 開始測評
                </button>
                <button id="viewHistoryBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-medium py-3 rounded-full transition-all duration-300 flex items-center justify-center gap-2 text-sm">
                    <i class="fa fa-history"></i> 管理員歷史紀錄
                </button>
            </div>
        </section>

        <!-- 問卷區塊 -->
        <section id="questionSection" class="bg-white p-6 rounded-xl card-shadow mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa fa-question-circle mr-3 text-blue-600"></i>人格測評問卷
                </h2>
                <span id="progressText" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full uppercase">1 / 12</span>
            </div>
            <div id="questionContainer" class="mb-8"></div>
            <div class="flex gap-4">
                <button id="prevQuestionBtn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 rounded-full disabled:opacity-30">上一題</button>
                <button id="nextQuestionBtn" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-full shadow-md">下一題</button>
            </div>
        </section>

        <!-- 結果區塊 -->
        <section id="resultSection" class="bg-white p-6 rounded-xl card-shadow mb-8 hidden">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa fa-star mr-3 text-blue-600"></i>您的測評結果
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button id="exportPdfBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-5 rounded-full shadow">
                        <i class="fa fa-file-pdf-o mr-1"></i>PDF 報告
                    </button>
                    <button id="restartBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-5 rounded-full shadow">
                        <i class="fa fa-refresh mr-1"></i>重新測評
                    </button>
                </div>
            </div>
            <div id="resultContent" class="space-y-4"></div>
        </section>

        <!-- 歷史紀錄 Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black/60 modal-backdrop hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-800">所有受測者紀錄分析</h3>
                    <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-700 p-2">
                        <i class="fa fa-times text-2xl"></i>
                    </button>
                </div>
                <div id="historyList" class="overflow-y-auto flex-grow p-6 bg-gray-50/50 space-y-4">
                    <!-- 歷史項目注入處 -->
                </div>
                <div class="p-4 border-t bg-white flex justify-between items-center">
                    <span class="text-xs text-gray-400 font-medium">* 顯示所有在線測試資料</span>
                    <button id="clearHistoryBtn" class="text-red-600 hover:text-red-700 text-sm font-bold px-4 py-2 border border-red-100 rounded-lg hover:bg-red-50">
                        <i class="fa fa-trash mr-1"></i>清空所有紀錄
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// ===== LINE LIFF 設定 =====
const LIFF_ID = "2008610266-8jDqPJAe";
let lineProfile = null;
let isLiffInit = false;

function setLineStatus(text, isError = false) {
    const el = document.getElementById('lineStatus');
    if (!el) return;
    el.textContent = text;
    el.className = `mb-4 text-sm rounded-lg p-3 border ${isError ? 'bg-red-50 border-red-100 text-red-700' : 'bg-blue-50 border-blue-100 text-gray-700'}`;
}

function renderLineProfile(profile) {
    const card = document.getElementById('lineProfileCard');
    const avatar = document.getElementById('lineAvatar');
    const nameText = document.getElementById('lineDisplayNameText');
    if (!card || !avatar || !nameText) return;
    avatar.src = profile.pictureUrl || "";
    nameText.textContent = profile.displayName || "";
    card.classList.remove('hidden');
}

async function initLine() {
    if (isLiffInit) return true;
    try {
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        isLiffInit = true;
        
        if (!liff.isLoggedIn()) {
            setLineStatus("正在引導登入 LINE...");
            // 優化登入重定向，不傳參數讓 LIFF 自動處理
            liff.login();
            return false;
        }
        
        lineProfile = await liff.getProfile();
        setLineStatus(`LINE 已連結：${lineProfile.displayName}`, false);
        renderLineProfile(lineProfile);
        document.getElementById('userName').value = lineProfile.displayName || "";
        return true;
    } catch (err) {
        console.error("LIFF Init Error:", err);
        setLineStatus("LINE 連接失敗，請確認在 LINE App 內開啟連結。", true);
        return false;
    }
}

// 香氛人格數據
const personalityData = {
    leader: { code: "01", name: "領導者 (Leader)", traits: "果斷、權威、目標導向", scentType: "木質辛香調", essentialOilFormula: "黑胡椒 + 肉桂皮 + 薑 + 佛手柑 + 檸檬", essentialOilName: "赤焰初心", perfumeFormula: "前：佛手柑/葡萄柚 | 中：黑胡椒/薑 | 後：雪松/乳香/岩蘭草", perfumeName: "王者脈動", colorName: "赤炎色", colorHex: "#FF4500", liuhe: "陽火", bodySystem: "循環系統", emotion: "驕傲 / 榮耀（正向自信）", sound: "陽宮音", scentMeaning: "帶領與決斷力", healthTips: "需要注意膽的疏泄功能，壓力大可能影響決斷力。", tribe: "猶大", blessingClue: "君王血脈，萬民歸順。 (創49:8-10)", scripture: "創世記 49:8-10" },
    collaborator: { code: "02", name: "合作者 (Collaborator)", traits: "親和、包容、溫暖", scentType: "白花麝香調", essentialOilFormula: "甜橙 + 天竺葵 + 薰衣草", essentialOilName: "晨曦擁抱", perfumeFormula: "前：橘子花 | 中：玫瑰 | 後：檀香", perfumeName: "光之和諧", colorName: "橙曦色", colorHex: "#FFA500", liuhe: "陰木", bodySystem: "神經系統", emotion: "信任 / 安心", sound: "陰羽音", scentMeaning: "溫暖包容", healthTips: "情緒敏感，需注意心血管系統。", tribe: "西緬", blessingClue: "分散聯合，融入各支派。 (創49:5-7)", scripture: "創世記 49:5-7" },
    creator: { code: "03", name: "創意者 (Creator)", traits: "靈感、自由、藝術性", scentType: "柑橘花香調", essentialOilFormula: "檸檬 + 佛手柑 + 羅勒", essentialOilName: "金光樂章", perfumeFormula: "前：檸檬 | 中：茉莉 | 後：雪松", perfumeName: "黃金靈感", colorName: "金光色", colorHex: "#FFD700", liuhe: "陽木", bodySystem: "消化系統", emotion: "快樂 / 靈感", sound: "陽角音", scentMeaning: "靈感創造力", healthTips: "情緒起伏大，心火過旺影響睡眠。", tribe: "亞設", blessingClue: "豐美尊榮，創作佳餚。 (創49:20)", scripture: "創世記 49:20" },
    implementer: { code: "04", name: "實踐者 (Implementer)", traits: "務實、穩定、耐力", scentType: "木質柑苔調", essentialOilFormula: "檜木 + 黑雲杉 + 絲柏", essentialOilName: "萃岩磐石", perfumeFormula: "前：迷迭香 | 中：絲柏 | 後：乳香", perfumeName: "大地之母", colorName: "翠岩色", colorHex: "#228B22", liuhe: "陽土", bodySystem: "肌肉系統", emotion: "期待 / 毅力", sound: "陽徵音", scentMeaning: "執行與穩健", healthTips: "過於保守固執，需注意消化功能。", tribe: "以薩迦", blessingClue: "負重前行，建造家園。 (創49:14-15)", scripture: "創世記 49:14-15" },
    adventurer: { code: "05", name: "冒險者 (Adventurer)", traits: "好奇、勇敢、自由", scentType: "清新木質調", essentialOilFormula: "薄荷 + 杜松 + 冷杉", essentialOilName: "芎蒼之風", perfumeFormula: "前：薄荷 | 中：葡萄柚 | 後：麝香", perfumeName: "森林勇氣", colorName: "蒼穹色", colorHex: "#00BFFF", liuhe: "陽金", bodySystem: "呼吸系統", emotion: "驚訝 / 勇氣", sound: "陽商音", scentMeaning: "探索與自由", healthTips: "好奇心強但缺耐心，注意膀胱經。", tribe: "西布倫", blessingClue: "航向四海，探索商機。 (創49:13)", scripture: "創世記 49:13" },
    guardian: { code: "06", name: "守護者 (Guardian)", traits: "忠誠、保護、安定", scentType: "草本花香木質調", essentialOilFormula: "乳香 + 絲柏 + 薰衣草", essentialOilName: "靛藍搖籃曲", perfumeFormula: "前：薰衣草 | 中：乳香 | 後：岩蘭草", perfumeName: "忠誠之盾", colorName: "靛藍色", colorHex: "#4B0082", liuhe: "陰火", bodySystem: "免疫系統", emotion: "愛 / 溫柔力量", sound: "陰宮音", scentMeaning: "保護與忠誠", healthTips: "過度擔憂、犧牲自我，注意脾胃。", tribe: "呂便", blessingClue: "身為長子，守護根基。 (創49:3-4)", scripture: "創世記 49:3-4" },
    explorer: { code: "07", name: "探索者 (Explorer)", traits: "神秘、追尋、靈性", scentType: "樹脂木質調", essentialOilFormula: "乳香 + 杜松 + 沈香子", essentialOilName: "紫晶聖壇", perfumeFormula: "前：黑胡椒 | 中：鼠尾草 | 後：琥珀", perfumeName: "靜謐之心", colorName: "紫晶色", colorHex: "#9370DB", liuhe: "陰靈", bodySystem: "內分泌系統", emotion: "神秘 / 直覺", sound: "陰角音", scentMeaning: "靈性追尋", healthTips: "孤僻，需注意全身氣機平衡。", tribe: "但", blessingClue: "獨闢蹊徑，智慧審判。 (創49:16-17)", scripture: "創世記 49:16-17" },
    achiever: { code: "08", name: "成就者 (Achiever)", traits: "目標、驅動力、榮耀", scentType: "木質草本辛香調", essentialOilFormula: "薑 + 黑胡椒 + 肉桂葉", essentialOilName: "鎏金權杖", perfumeFormula: "前：生薑 | 中：佛手柑 | 後：乳香", perfumeName: "榮耀桂冠", colorName: "鎏金色", colorHex: "#DAA520", liuhe: "陽火", bodySystem: "消化＋肝膽", emotion: "憤怒→驅動力", sound: "陽羽音", scentMeaning: "成就與榮耀", healthTips: "壓力巨大，需注意肝氣疏泄。", tribe: "迦得", blessingClue: "戰士精神，終必得勝。 (創49:19)", scripture: "創世記 49:19" },
    idealist: { code: "09", name: "理想者 (Idealist)", traits: "浪漫、純潔、理想性", scentType: "花香柑苔調", essentialOilFormula: "天竺葵 + 薰衣草 + 佛手柑", essentialOilName: "月光聖杯", perfumeFormula: "前：橙花 | 中：玫瑰 | 後：白麝香", perfumeName: "豐盛花園", colorName: "月光色", colorHex: "#F0E68C", liuhe: "陰木", bodySystem: "呼吸 / 肺系統", emotion: "悲傷→慈悲", sound: "陰商音", scentMeaning: "浪漫與理想", healthTips: "不切實際，需注意呼吸系統。", tribe: "便雅憫", blessingClue: "驍勇善戰，實現理想。 (創49:27)", scripture: "創世記 49:27" },
    inspirator: { code: "10", name: "靈感者 (Inspirator)", traits: "靈性、啟發、無限", scentType: "熏香琥珀調", essentialOilFormula: "檸檬 + 快樂鼠尾草 + 綠花白千層", essentialOilName: "銀河星塵", perfumeFormula: "前：薄荷 | 中：迷迭香 | 後：琥珀", perfumeName: "啟迪之光", colorName: "銀河色", colorHex: "#E6E6FA", liuhe: "陽靈", bodySystem: "泌尿 / 腎系統", emotion: "焦慮→靈感", sound: "陽徵音", scentMeaning: "啟迪與靈性", healthTips: "內在矛盾，注意泌尿與腎精。", tribe: "拿弗他利", blessingClue: "自由釋放，言語嘉美。 (創49:21)", scripture: "創世記 49:21" },
    architect: { code: "11", name: "建築大師 (Architect)", traits: "穩固、結構、務實", scentType: "綠意柑苔調", essentialOilFormula: "黑雲杉 + 肖楠 + 芳樟", essentialOilName: "大地基石", perfumeFormula: "前：黑胡椒 | 中：雪松 | 後：岩蘭草", perfumeName: "蒼翠之柱", colorName: "大地色", colorHex: "#8B4513", liuhe: "陰土", bodySystem: "骨骼 / 皮膚系統", emotion: "羞愧→責任", sound: "陰羽音", scentMeaning: "結構與穩固", healthTips: "責任感重，需注意腸道健康。", tribe: "約瑟", blessingClue: "啟示豐盛，建立未來。 (創49:22-26)", scripture: "創世記 49:22-26" },
    soulMentor: { code: "12", name: "靈魂導師 (Soul Mentor)", traits: "智慧、聖潔、啟迪", scentType: "花香東方調", essentialOilFormula: "乳香 + 安息香 + 沈香子", essentialOilName: "聖愛光冕", perfumeFormula: "前：橙花 | 中：沒藥 | 後：琥珀", perfumeName: "聖潔同在", colorName: "聖光色", colorHex: "#FFFACD", liuhe: "陰靈", bodySystem: "生殖＋小腸", emotion: "愛 / 智慧", sound: "陰徵音", scentMeaning: "聖潔與啟發", healthTips: "過度犧牲，注意小腸與營養吸收。", tribe: "利未", blessingClue: "分別為聖，教導律法。 (申33:10)", scripture: "申命記 33:8-11" }
};

const questions = [
    { id: 1, text: "我喜歡設定方向並帶領他人完成目標。", dimension: "leader" }, 
    { id: 2, text: "我重視團隊合作，願意聆聽並支持他人。", dimension: "collaborator" }, 
    { id: 3, text: "我富有創意，喜歡嘗試新點子或藝術表達。", dimension: "creator" }, 
    { id: 4, text: "我務實穩健，喜歡按計劃持續推進。", dimension: "implementer" }, 
    { id: 5, text: "我喜歡冒險和探索未知，對新體驗充滿好奇。", dimension: "adventurer" }, 
    { id: 6, text: "我具備保護他人與提供支持的天性。", dimension: "guardian" }, 
    { id: 7, text: "我對宇宙與自我靈性層面感興趣。", dimension: "explorer" }, 
    { id: 8, text: "我有強烈的目標感和驅動力。", dimension: "achiever" }, 
    { id: 9, text: "我注重理想與浪漫，常常從夢想獲得力量。", dimension: "idealist" }, 
    { id: 10, text: "我對靈性與啟發性的經驗感興趣。", dimension: "inspirator" }, 
    { id: 11, text: "我善於建立結構與秩序，重視實用。", dimension: "architect" }, 
    { id: 12, text: "我渴望啟迪他人靈魂，追求智慧的生活。", dimension: "soulMentor" }
];

let currentQuestionIndex = 0;
const responses = {};
const STORAGE_KEY = 'fragrancePersonalityResults';

// 頁面元件
const infoSection = document.getElementById('infoSection');
const questionSection = document.getElementById('questionSection');
const resultSection = document.getElementById('resultSection');
const questionContainer = document.getElementById('questionContainer');
const prevQuestionBtn = document.getElementById('prevQuestionBtn');
const nextQuestionBtn = document.getElementById('nextQuestionBtn');
const resultContent = document.getElementById('resultContent');
const historyModal = document.getElementById('historyModal');
const historyList = document.getElementById('historyList');

// 事件監聽
document.getElementById('startTestBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const ok = await initLine();
    if (!ok) return;
    if (!document.getElementById('userName').value.trim()) return alert("請輸入受測者姓名！");
    
    currentQuestionIndex = 0;
    Object.keys(responses).forEach(key => delete responses[key]);
    infoSection.classList.add('hidden');
    questionSection.classList.remove('hidden');
    renderQuestion();
});

document.getElementById('viewHistoryBtn').addEventListener('click', () => {
    const password = prompt("請輸入管理員密碼：");
    if (password === "a19690712") {
        loadHistory();
        historyModal.classList.remove('hidden');
    } else if (password !== null) {
        alert('密碼錯誤！');
    }
});

document.getElementById('closeHistoryBtn').onclick = () => historyModal.classList.add('hidden');

document.getElementById('clearHistoryBtn').onclick = () => {
    if (confirm('確定要清空伺服器上所有受測紀錄嗎？')) {
        localStorage.removeItem(STORAGE_KEY);
        loadHistory();
    }
};

// 核心功能：加載詳細歷史紀錄
function loadHistory() {
    historyList.innerHTML = '';
    const results = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (results.length === 0) {
        historyList.innerHTML = '<div class="text-center py-20 text-gray-400">尚無受測紀錄</div>';
        return;
    }
    // 依時間降序排序 (最新在前面)
    results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    results.forEach((item) => {
        const lineName = (item.line && item.line.displayName) ? item.line.displayName : '未知';
        const lineId = (item.line && item.line.userId) ? item.line.userId : '無資料';
        
        const div = document.createElement('div');
        div.className = 'bg-white border-2 border-gray-100 rounded-2xl p-5 mb-4 hover:border-blue-400 hover:shadow-lg cursor-pointer transition-all duration-300';
        div.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-black uppercase tracking-wider">受測姓名</span>
                        <p class="font-black text-gray-800 text-lg">${item.userName}</p>
                    </div>
                    <div class="flex flex-col text-xs text-gray-500 space-y-1 bg-gray-50 p-2 rounded-lg">
                        <p><i class="fa fa-user-circle mr-1 text-blue-400"></i>LINE 名稱: <span class="text-gray-800 font-bold">${lineName}</span></p>
                        <p class="font-mono text-[10px] text-gray-400">LINE ID: ${lineId}</p>
                    </div>
                </div>
                <div class="md:text-right flex flex-col justify-between border-t md:border-t-0 pt-2 md:pt-0">
                    <div>
                        <p class="text-sm text-gray-700 font-bold"><i class="fa fa-phone mr-1 text-green-500"></i>電話: ${item.userPhone || '未提供'}</p>
                        <div class="mt-2">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">分析結果人格</span>
                            <p class="text-blue-600 font-black text-xl">${item.type}</p>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 font-medium italic mt-2">${new Date(item.timestamp).toLocaleString()}</p>
                </div>
            </div>
        `;
        div.onclick = () => {
            historyModal.classList.add('hidden');
            infoSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            renderResultCard(item);
        };
        historyList.appendChild(div);
    });
}

// 問卷邏輯
function renderQuestion() {
    const q = questions[currentQuestionIndex];
    const progress = Math.round(((currentQuestionIndex + 1) / questions.length) * 100);
    
    document.getElementById('progressText').textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
    questionContainer.innerHTML = `
        <div class="w-full bg-gray-100 h-2 rounded-full mb-6 overflow-hidden">
            <div class="bg-blue-600 h-full transition-all duration-500" style="width: ${progress}%"></div>
        </div>
        <h3 class="text-xl font-bold mb-8 text-gray-800 leading-snug">${q.text}</h3>
        <div class="space-y-4">
            ${[1,2,3,4,5].map(v => `
                <label class="flex items-center p-4 border-2 rounded-2xl hover:bg-blue-50 cursor-pointer transition-all duration-200 ${responses[q.dimension] === v ? 'border-blue-500 bg-blue-50 ring-4 ring-blue-50' : 'border-gray-100'}">
                    <input type="radio" name="q" value="${v}" class="hidden" ${responses[q.dimension] === v ? 'checked' : ''} onchange="selectValue('${q.dimension}', ${v})">
                    <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-4 ${responses[q.dimension] === v ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-300 bg-white'}">
                        ${responses[q.dimension] === v ? '<i class="fa fa-check text-[10px]"></i>' : ''}
                    </div>
                    <span class="text-gray-700 font-bold">
                        ${v===1?'非常不同意':v===2?'不同意':v===3?'中立':v===4?'同意':'非常同意'}
                    </span>
                </label>`).join('')}
        </div>`;
    prevQuestionBtn.disabled = currentQuestionIndex === 0;
    nextQuestionBtn.textContent = currentQuestionIndex === questions.length - 1 ? '提交測評結果' : '下一題';
}

window.selectValue = (dim, val) => {
    responses[dim] = val;
    renderQuestion();
};

nextQuestionBtn.onclick = () => {
    const q = questions[currentQuestionIndex];
    if (!responses[q.dimension]) return alert('請選擇一個符合您的程度！');
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++; renderQuestion();
    } else { showResult(); }
};

prevQuestionBtn.onclick = () => { currentQuestionIndex--; renderQuestion(); };

function showResult() {
    questionSection.classList.add('hidden');
    resultSection.classList.remove('hidden');
    const bestScore = Math.max(...Object.values(responses));
    const tiedDimensions = Object.keys(responses).filter(dim => responses[dim] === bestScore);
    const bestDim = tiedDimensions[Math.floor(Math.random() * tiedDimensions.length)];
    const result = personalityData[bestDim];
    
    const obj = { 
        userName: document.getElementById('userName').value.trim(), 
        userPhone: document.getElementById('userPhone').value.trim(),
        userNote: document.getElementById('userNote').value.trim(),
        timestamp: new Date().toISOString(), 
        type: result.name, resultCode: result.code, resultKey: bestDim, 
        line: lineProfile, details: result 
    };
    saveResult(obj);
    renderResultCard(obj);
}

function saveResult(obj) {
    let local = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    local.push(obj);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(local));
    // Netlify Forms Submission
    const body = new URLSearchParams({
        'form-name': 'test-results',
        ...obj,
        'lineUserId': obj.line?.userId || '',
        'lineDisplayName': obj.line?.displayName || '',
        'resultType': obj.type,
        'details': JSON.stringify(obj.details)
    });
    fetch('/', { method: 'POST', body }).catch(e => console.error(e));
}

function renderResultCard(obj) {
    const res = obj.details;
    resultContent.innerHTML = `
        <div class="bg-blue-600 p-8 text-white rounded-t-2xl relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="text-3xl font-black">${obj.userName} 的香氛人格報告</h3>
                <p class="text-blue-100 text-sm opacity-80 mt-2 font-medium">測評日期：${new Date(obj.timestamp).toLocaleDateString()}</p>
            </div>
            <div class="absolute -right-10 -bottom-10 opacity-10 text-[120px] font-black italic">TYPE ${res.code}</div>
        </div>
        <div class="p-8 bg-white border-x border-b rounded-b-2xl">
            <div class="flex items-center gap-6 mb-8">
                <div class="w-16 h-16 rounded-full shadow-lg border-4 border-white" style="background-color: ${res.colorHex};"></div>
                <div>
                    <div class="text-blue-600 font-black text-xs uppercase tracking-widest">Personality Type</div>
                    <div class="text-3xl font-black text-gray-800">${res.name}</div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="p-4 bg-gray-50 rounded-2xl">
                    <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">人格特質描述</span>
                    <p class="text-slate-700 font-bold leading-relaxed">${res.traits}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-5 bg-blue-50/50 rounded-2xl border border-blue-100">
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest block mb-2">專屬精油建議</span>
                        <p class="font-black text-blue-800 text-lg mb-1">${res.essentialOilName}</p>
                        <p class="text-xs text-blue-600 font-medium">${res.essentialOilFormula}</p>
                    </div>
                    <div class="p-5 bg-purple-50/50 rounded-2xl border border-purple-100">
                        <span class="text-[10px] font-black text-purple-500 uppercase tracking-widest block mb-2">專屬香水建議</span>
                        <p class="font-black text-purple-800 text-lg mb-1">${res.perfumeName}</p>
                        <p class="text-xs text-purple-600 font-medium">${res.perfumeFormula}</p>
                    </div>
                </div>
                <div class="p-6 bg-amber-50 rounded-2xl mt-6 border-2 border-amber-100 relative">
                    <i class="fa fa-quote-left absolute top-4 left-4 text-amber-200 text-3xl"></i>
                    <div class="relative z-10 pl-6">
                        <div class="text-xs font-black text-amber-600 mb-2 tracking-widest uppercase">靈魂支派祝福：${res.tribe}</div>
                        <p class="text-amber-900 font-bold italic leading-relaxed text-lg mb-3">"${res.blessingClue}"</p>
                        <p class="text-[10px] text-amber-400 font-black text-right">— ${res.scripture}</p>
                    </div>
                </div>
            </div>
        </div>`;
}

async function exportReport(obj) {
    const { jsPDF } = window.jspdf;
    const element = document.getElementById('resultContent');
    const canvas = await html2canvas(element, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'pt', 'a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, w, h);
    pdf.save(`${obj.userName}_十二香氛人格報告.pdf`);
}

// 初始化啟動
window.onload = async () => {
    await initLine();
    // 自動開始邏輯
    if (sessionStorage.getItem('AUTO_START_TEST') === '1' && window.liff && liff.isLoggedIn()) {
        sessionStorage.removeItem('AUTO_START_TEST');
        setTimeout(() => document.getElementById('startTestBtn').click(), 400);
    }
};
    </script>
</body>
</html>
