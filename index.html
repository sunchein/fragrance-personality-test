<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>十二香氛人格測評系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal-backdrop { backdrop-filter: blur(3px); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <!-- Netlify Form 隱藏欄位 -->
    <form name="test-results" netlify netlify-honeypot="bot-field" hidden>
        <input name="userName" /><input name="userPhone" /><input name="userNote" />
        <input name="resultType" /><input name="lineUserId" /><input name="lineDisplayName" />
        <input name="resultCode" /><input name="timestamp" />
    </form>

    <!-- 加載遮罩 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-slate-500 text-sm animate-pulse">正在安全連接 LINE...</p>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-black text-slate-800 mb-2">十二香氛人格測評</h1>
            <p class="text-slate-500">探索您的支派靈魂與專屬香氛</p>
        </header>

        <!-- 受測者資訊區 -->
        <section id="infoSection" class="bg-white p-6 rounded-2xl card-shadow mb-8">
            <div id="lineStatus" class="hidden mb-4 p-3 rounded-xl text-xs font-medium"></div>

            <div id="profileCard" class="flex items-center gap-4 mb-6 p-4 bg-slate-50 rounded-2xl border border-slate-100 hidden">
                <img id="userAvatar" class="w-14 h-14 rounded-full border-2 border-white shadow-sm" src="" alt="Avatar">
                <div>
                    <div class="text-xs text-slate-400">歡迎回來</div>
                    <div id="displayName" class="text-lg font-bold text-slate-800">載入中...</div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">您的姓名</label>
                    <input id="userName" type="text" class="w-full border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="請輸入姓名">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">聯絡電話 (選填)</label>
                    <input id="userPhone" type="tel" class="w-full border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="以便我們為您提供建議">
                </div>
            </div>

            <button id="startTestBtn" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2">
                <i class="fa fa-magic"></i> 開始人格分析
            </button>
            
            <button id="viewHistoryBtn" class="w-full mt-3 text-slate-400 text-sm font-medium hover:text-slate-600 py-2">
                <i class="fa fa-lock mr-1"></i> 管理員歷史紀錄
            </button>
        </section>

        <!-- 題目區 -->
        <section id="questionSection" class="bg-white p-6 rounded-2xl card-shadow mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <span id="progressText" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full uppercase">Question 1 / 12</span>
            </div>
            <div id="questionContainer"></div>
            <div class="flex gap-3 mt-8">
                <button id="prevBtn" class="flex-1 bg-slate-100 text-slate-500 font-bold py-3 rounded-xl disabled:opacity-30">上一題</button>
                <button id="nextBtn" class="flex-[2] bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md">下一題</button>
            </div>
        </section>

        <!-- 結果區 -->
        <section id="resultSection" class="hidden animate-in fade-in duration-700">
            <div id="resultContent" class="bg-white rounded-2xl card-shadow overflow-hidden mb-6">
                <!-- 由 JS 動態注入內容 -->
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button id="exportPdfBtn" class="bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg"><i class="fa fa-file-pdf-o mr-2"></i>保存 PDF</button>
                <button id="restartBtn" class="bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg"><i class="fa fa-refresh mr-2"></i>重新測試</button>
            </div>
        </section>
    </div>

    <!-- 歷史紀錄 Modal -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/60 modal-backdrop z-[110] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-800">管理紀錄</h3>
                <button id="closeHistory" class="text-slate-400"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div id="historyList" class="overflow-y-auto p-5 space-y-3"></div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008610266-8jDqPJAe";
        let lineProfile = null;
        let currentIdx = 0;
        const responses = {};

        // 初始化
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                lineProfile = await liff.getProfile();
                document.getElementById('profileCard').classList.remove('hidden');
                document.getElementById('userAvatar').src = lineProfile.pictureUrl;
                document.getElementById('displayName').textContent = lineProfile.displayName;
                document.getElementById('userName').value = lineProfile.displayName;

                // 檢查好友狀態
                try {
                    const status = await liff.getFriendshipStatus();
                    const statusEl = document.getElementById('lineStatus');
                    statusEl.classList.remove('hidden');
                    if (status.friendFlag) {
                        statusEl.textContent = "✓ 已加入官方帳號好友";
                        statusEl.className = "mb-4 p-3 rounded-xl text-xs font-medium bg-green-50 text-green-600 border border-green-100";
                    } else {
                        statusEl.textContent = "! 建議加入好友以接收後續通知";
                        statusEl.className = "mb-4 p-3 rounded-xl text-xs font-medium bg-amber-50 text-amber-600 border border-amber-100";
                    }
                } catch (e) { console.log("Friendship scope missing"); }

                hideLoading();
            } catch (err) {
                console.error(err);
                alert("LINE 登入失敗，請確認於 LINE 內開啟。");
            }
        }

        function hideLoading() {
            const loader = document.getElementById('loadingOverlay');
            loader.classList.add('opacity-0');
            setTimeout(() => loader.classList.add('hidden'), 400);
        }

        // 資料庫 (擷取部分，完整版同前次)
        const personalityData = {
            leader: { code: "01", name: "領導者 (Leader)", traits: "果斷、權威、目標導向", scentType: "木質辛香調", essentialOilFormula: "黑胡椒 + 肉桂皮 + 薑 + 佛手柑 + 檸檬", essentialOilName: "赤焰初心", perfumeFormula: "前：佛手柑/葡萄柚 | 中：黑胡椒/薑 | 後：雪松/乳香/岩蘭草", perfumeName: "王者脈動", colorHex: "#FF4500", tribe: "猶大", scripture: "創世記 49:8-10", blessing: "君王血脈，萬民歸順。" },
            collaborator: { code: "02", name: "合作者 (Collaborator)", traits: "親和、包容、溫暖", scentType: "白花麝香調", essentialOilFormula: "甜橙 + 天竺葵 + 薰衣草", essentialOilName: "晨曦擁抱", perfumeFormula: "前：橘子花 | 中：玫瑰 | 後：檀香/琥珀", perfumeName: "光之和諧", colorHex: "#FFA500", tribe: "西緬", scripture: "創世記 49:5-7", blessing: "分散聯合，融入各支派。" },
            creator: { code: "03", name: "創意者 (Creator)", traits: "靈感、自由、藝術性", scentType: "柑橘花香調", essentialOilFormula: "檸檬 + 佛手柑 + 羅勒", essentialOilName: "金光樂章", perfumeFormula: "前：檸檬 | 中：茉莉 | 後：雪松", perfumeName: "黃金靈感", colorHex: "#FFD700", tribe: "亞設", scripture: "創世記 49:20", blessing: "豐美尊榮，創作佳餚。" },
            implementer: { code: "04", name: "實踐者 (Implementer)", traits: "務實、穩定、耐力", scentType: "木質柑苔調", essentialOilFormula: "檜木 + 黑雲杉 + 絲柏", essentialOilName: "萃岩磐石", perfumeFormula: "前：迷迭香 | 中：薰衣草 | 後：乳香", perfumeName: "大地之母", colorHex: "#228B22", tribe: "以薩迦", scripture: "創世記 49:14-15", blessing: "負重前行，建造家園。" },
            adventurer: { code: "05", name: "冒險者 (Adventurer)", traits: "好奇、勇敢、自由", scentType: "清新木質調", essentialOilFormula: "薄荷 + 杜松 + 冷杉", essentialOilName: "芎蒼之風", perfumeFormula: "前：葡萄柚 | 中：薄荷 | 後：麝香", perfumeName: "森林勇氣", colorHex: "#00BFFF", tribe: "西布倫", scripture: "創世記 49:13", blessing: "航向四海，探索商機。" },
            guardian: { code: "06", name: "守護者 (Guardian)", traits: "忠誠、保護、安定", scentType: "草本花香木質調", essentialOilFormula: "乳香 + 絲柏 + 薰衣草", essentialOilName: "靛藍搖籃曲", perfumeFormula: "前：薰衣草 | 中：沒藥 | 後：岩蘭草", perfumeName: "忠誠之盾", colorHex: "#4B0082", tribe: "呂便", scripture: "創世記 49:3-4", blessing: "身為長子，守護根基。" },
            explorer: { code: "07", name: "探索者 (Explorer)", traits: "神秘、追尋、靈性", scentType: "樹脂木質調", essentialOilFormula: "乳香 + 杜松 + 沈香子", essentialOilName: "紫晶聖壇", perfumeFormula: "前：黑胡椒 | 中：鼠尾草 | 後：琥珀", perfumeName: "靜謐之心", colorHex: "#9370DB", tribe: "但", scripture: "創世記 49:16-17", blessing: "獨闢蹊徑，智慧審判。" },
            achiever: { code: "08", name: "成就者 (Achiever)", traits: "目標、驅動力、榮耀", scentType: "木質辛香調", essentialOilFormula: "薑 + 黑胡椒 + 肉桂葉", essentialOilName: "鎏金權杖", perfumeFormula: "前：佛手柑 | 中：生薑 | 後：乳香", perfumeName: "榮耀桂冠", colorHex: "#DAA520", tribe: "迦得", scripture: "創世記 49:19", blessing: "戰士精神，終必得勝。" },
            idealist: { code: "09", name: "理想者 (Idealist)", traits: "浪漫、純潔、理想性", scentType: "花香柑苔調", essentialOilFormula: "天竺葵 + 薰衣草 + 佛手柑", essentialOilName: "月光聖杯", perfumeFormula: "前：橙花 | 中：玫瑰 | 後：白麝香", perfumeName: "豐盛花園", colorHex: "#F0E68C", tribe: "便雅憫", scripture: "創世記 49:27", blessing: "驍勇善戰，實現理想。" },
            inspirator: { code: "10", name: "靈感者 (Inspirator)", traits: "靈性、啟發、無限", scentType: "熏香琥珀調", essentialOilFormula: "檸檬 + 快樂鼠尾草 + 綠花白千層", essentialOilName: "銀河星塵", perfumeFormula: "前：薄荷 | 中：迷迭香 | 後：琥珀", perfumeName: "啟迪之光", colorHex: "#E6E6FA", tribe: "拿弗他利", scripture: "創世記 49:21", blessing: "自由釋放，言語嘉美。" },
            architect: { code: "11", name: "建築大師 (Architect)", traits: "穩固、結構、務實", scentType: "綠意柑苔調", essentialOilFormula: "黑雲杉 + 肖楠 + 芳樟", essentialOilName: "大地基石", perfumeFormula: "前：黑胡椒 | 中：雪松 | 後：岩蘭草", perfumeName: "蒼翠之柱", colorHex: "#8B4513", tribe: "約瑟", scripture: "創世記 49:22-26", blessing: "啟示豐盛，建立未來。" },
            soulMentor: { code: "12", name: "靈魂導師 (Soul Mentor)", traits: "智慧、聖潔、啟迪", scentType: "花香東方調", essentialOilFormula: "乳香 + 安息香 + 沈香子", essentialOilName: "聖愛光冕", perfumeFormula: "前：佛手柑 | 中：乳香/沒藥 | 後：琥珀/麝香", perfumeName: "聖潔同在", colorHex: "#FFFACD", tribe: "利未", scripture: "申命記 33:8-11", blessing: "分別為聖，教導律法。" }
        };

        const questions = [
            { id: 1, text: "我喜歡設定方向並帶領他人完成目標。", dim: "leader" },
            { id: 2, text: "我重視團隊合作，願意聆聽並支持他人。", dim: "collaborator" },
            { id: 3, text: "我富有創意，喜歡嘗試新點子或藝術表達。", dim: "creator" },
            { id: 4, text: "我務實穩健，喜歡按計劃持續推進。", dim: "implementer" },
            { id: 5, text: "我喜歡冒險和探索未知，對新體驗充滿好奇。", dim: "adventurer" },
            { id: 6, text: "我具備保護他人與提供支持的天性。", dim: "guardian" },
            { id: 7, text: "我對自我靈性層面感興趣，喜歡探索神秘。", dim: "explorer" },
            { id: 8, text: "我有強烈的目標感和驅動力。", dim: "achiever" },
            { id: 9, text: "我注重理想與浪漫，常常從夢想獲得力量。", dim: "idealist" },
            { id: 10, text: "我對啟發性的經驗感興趣，尋求內在洞察。", dim: "inspirator" },
            { id: 11, text: "我善於建立結構與秩序，重視穩固。", dim: "architect" },
            { id: 12, text: "我渴望啟迪他人靈魂，追求智慧的生活。", dim: "soulMentor" }
        ];

        // 邏輯控制
        document.getElementById('startTestBtn').onclick = () => {
            if (!document.getElementById('userName').value) return alert("請輸入姓名");
            infoSection.classList.add('hidden');
            document.getElementById('questionSection').classList.remove('hidden');
            renderQ();
        };

        function renderQ() {
            const q = questions[currentIdx];
            document.getElementById('progressText').textContent = `Question ${currentIdx + 1} / ${questions.length}`;
            document.getElementById('questionContainer').innerHTML = `
                <h3 class="text-xl font-bold text-slate-800 mb-6">${q.text}</h3>
                <div class="space-y-3">
                    ${[1,2,3,4,5].map(v => `
                        <button onclick="selectAns('${q.dim}', ${v})" class="w-full text-left p-4 border rounded-xl font-medium transition-all ${responses[q.dim] === v ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-slate-100 hover:border-blue-200'}">
                            ${v===1?'非常不同意':v===2?'不同意':v===3?'普通':v===4?'同意':'非常同意'}
                        </button>
                    `).join('')}
                </div>`;
            document.getElementById('prevBtn').disabled = currentIdx === 0;
        }

        window.selectAns = (dim, v) => {
            responses[dim] = v;
            renderQ();
        };

        document.getElementById('nextBtn').onclick = () => {
            if (!responses[questions[currentIdx].dim]) return alert("請選擇一個選項");
            if (currentIdx < questions.length - 1) {
                currentIdx++;
                renderQ();
            } else {
                calcResult();
            }
        };

        document.getElementById('prevBtn').onclick = () => { currentIdx--; renderQ(); };

        function calcResult() {
            const scores = Object.values(responses);
            const max = Math.max(...scores);
            const ties = Object.keys(responses).filter(d => responses[d] === max);
            const win = ties[Math.floor(Math.random() * ties.length)];
            const data = personalityData[win];
            
            document.getElementById('questionSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            
            const resObj = {
                userName: document.getElementById('userName').value,
                userPhone: document.getElementById('userPhone').value,
                timestamp: new Date().toISOString(),
                type: data.name,
                line: lineProfile,
                details: data
            };
            
            save(resObj);
            renderResult(resObj);
        }

        function renderResult(obj) {
            const d = obj.details;
            document.getElementById('resultContent').innerHTML = `
                <div class="p-6 text-white" style="background-color: ${d.colorHex}">
                    <div class="text-xs font-bold opacity-80 uppercase tracking-widest">Your Soul Type</div>
                    <h2 class="text-3xl font-black mt-1">${d.name}</h2>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Core Traits 核心特質</span>
                        <p class="text-slate-700 font-bold text-lg">${d.traits}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <span class="text-[10px] font-bold text-blue-500 block mb-1">精油配方</span>
                            <div class="font-bold text-slate-800 text-sm">${d.essentialOilName}</div>
                            <div class="text-xs text-slate-500">${d.essentialOilFormula}</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <span class="text-[10px] font-bold text-purple-500 block mb-1">香水配方</span>
                            <div class="font-bold text-slate-800 text-sm">${d.perfumeName}</div>
                            <div class="text-xs text-slate-500">${d.perfumeFormula}</div>
                        </div>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                        <div class="text-xs font-bold text-blue-800 mb-1">支派祝福：${d.tribe}</div>
                        <p class="text-sm italic text-blue-900 mb-2">"${d.blessing}"</p>
                        <div class="text-[10px] text-blue-400 font-medium">${d.scripture}</div>
                    </div>
                </div>`;
        }

        async function save(obj) {
            // Local
            const history = JSON.parse(localStorage.getItem('frag_hist') || '[]');
            history.push(obj);
            localStorage.setItem('frag_hist', JSON.stringify(history));

            // Netlify
            const body = new URLSearchParams({
                'form-name': 'test-results',
                ...obj,
                'lineUserId': obj.line?.userId || '',
                'lineDisplayName': obj.line?.displayName || '',
                'resultType': obj.type
            });
            fetch('/', { method: 'POST', body });
        }

        document.getElementById('exportPdfBtn').onclick = async () => {
            const { jsPDF } = window.jspdf;
            const canvas = await html2canvas(document.getElementById('resultContent'), { scale: 2 });
            const pdf = new jsPDF('p', 'mm', 'a4');
            const w = pdf.internal.pageSize.getWidth();
            const h = (canvas.height * w) / canvas.width;
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, h);
            pdf.save(`人格報告.pdf`);
        };

        document.getElementById('restartBtn').onclick = () => window.location.reload();

        // 管理員功能
        document.getElementById('viewHistoryBtn').onclick = () => {
            if (prompt("密碼") === "sun20020503") {
                document.getElementById('historyModal').classList.remove('hidden');
                const list = JSON.parse(localStorage.getItem('frag_hist') || '[]');
                document.getElementById('historyList').innerHTML = list.reverse().map(h => `
                    <div class="p-3 bg-slate-50 rounded-lg text-sm">
                        <div class="font-bold text-slate-800">${h.userName}</div>
                        <div class="text-blue-600 text-xs">${h.type}</div>
                        <div class="text-[10px] text-slate-400">${new Date(h.timestamp).toLocaleString()}</div>
                    </div>
                `).join('') || '無紀錄';
            }
        };
        document.getElementById('closeHistory').onclick = () => document.getElementById('historyModal').classList.add('hidden');

        window.onload = init;
    </script>
</body>
</html>
